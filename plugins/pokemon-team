import userDB from '../lib/userDatabase.js'

let handler = async (m, { conn, text, usedPrefix, command }) => {
    let user = await userDB.getUser(m.sender)
    let team = user.team || []

    if (team.length === 0) return m.reply('âŒ No tienes PokÃ©mon en tu equipo. Â¡Usa .start!')

    // LÃ³gica para cambiar el orden del equipo (.invpk 2)
    if (text) {
        let idx = parseInt(text) - 1
        if (idx > 0 && idx < team.length) {
            let [selected] = team.splice(idx, 1)
            team.unshift(selected) // Mover al primer puesto
            await userDB.saveUser(m.sender)
            return m.reply(`âœ… *${selected.name}* ahora es el lÃ­der de tu equipo.`)
        }
    }

    let txt = `ðŸ‘¥ *EQUIPO POKÃ‰MON* ðŸ‘¥\n`
    txt += `ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£\n`

    team.forEach((pk, i) => {
        let healthIcon = pk.hp <= 0 ? 'ðŸ’€' : pk.hp < (pk.maxHp / 2) ? 'âš ï¸' : 'âœ…'
        txt += `${i === 0 ? 'â­' : 'â–ªï¸'} *${i + 1}. ${pk.name.toUpperCase()}* [Lv. ${pk.level}]\n`
        txt += `   ${healthIcon} HP: ${pk.hp}/${pk.maxHp} | XP: ${pk.xp}/100\n`
        if (i === 0) {
            txt += `   âš”ï¸ Ataques: ${pk.moves.join(', ')}\n`
        }
        txt += `\n`
    })

    txt += `ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£\n`
    txt += `ðŸ’¡ *Para cambiar lÃ­der:* \`${usedPrefix + command} [nÃºmero]\`\n`
    txt += `ðŸ’¡ *Para ver stats:* \`.poke [nÃºmero]\``
    
    await conn.reply(m.chat, txt, m)
}

handler.command = /^(invpk|equipo|team)$/i
export default handler
